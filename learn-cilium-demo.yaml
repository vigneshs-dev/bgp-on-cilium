---
apiVersion: v1
kind: Namespace
metadata:
  name: cilium-demo
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-demo
  namespace: cilium-demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-demo
  template:
    metadata:
      labels:
        app: nginx-demo
    spec:
      containers:
        - name: nginx
          image: nginx:stable
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-demo
  namespace: cilium-demo
spec:
  type: ClusterIP
  selector:
    app: nginx-demo
  ports:
    - port: 80
      targetPort: 80
---
# Example CiliumNetworkPolicy: allow ingress to nginx-demo from same namespace only
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-from-same-namespace
  namespace: cilium-demo
spec:
  endpointSelector:
    matchLabels:
      app: nginx-demo
  ingress:
    - fromEndpoints:
        - matchLabels:
            "k8s:io.kubernetes.pod.namespace": "cilium-demo"
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
  # Allow egress to anywhere from the pods
  egress:
    - {}
---
# Optional Kubernetes NetworkPolicy equivalent (commented out):
# apiVersion: networking.k8s.io/v1
# kind: NetworkPolicy
# metadata:
#   name: allow-same-namespace-np
#   namespace: cilium-demo
# spec:
#   podSelector:
#     matchLabels:
#       app: nginx-demo
#   policyTypes:
#     - Ingress
#     - Egress
#   ingress:
#     - from:
#         - podSelector: {}
#   egress:
#     - {}
