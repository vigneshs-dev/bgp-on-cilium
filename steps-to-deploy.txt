# Deploy Kind cluster
kind create cluster --config cluster.yaml

# Deploy Container Lab
containerlab -t topo.yaml deploy

# Command to run ContainerLab Graph
docker run -d \
  --name clab-ui \
  -p 50080:50080 \
  -v $(pwd)/topo.yaml:/topo.yaml \
  -v /var/run/docker.sock:/var/run/docker.sock \
  ghcr.io/srl-labs/clab:0.59.0 \
  containerlab graph -t /topo.yaml


# Verify connectivity
docker exec -it clab-bgp-topo-router0 vtysh -c 'show bgp ipv4 summary wide'

docker exec -it clab-bgp-topo-tor0 vtysh -c 'show bgp ipv4 summary wide'
docker exec -it clab-bgp-topo-tor1 vtysh -c 'show bgp ipv4 summary wide'

# Cilium install command

cilium install \
    --version v1.17.4 \
    --set ipam.mode=kubernetes \
    --set routingMode=native \
    --set ipv4NativeRoutingCIDR="10.0.0.0/8" \
    --set bgpControlPlane.enabled=true \
    --set k8s.requireIPv4PodCIDR=true

cilium config view | grep enable-bgp

kubectl get nodes -l 'rack in (rack0,rack1)'

# Apply Policies
kubectl apply -f cilium-bgp-peering-policies.yaml

kubectl apply -f netshoot-ds.yaml
kubectl rollout status ds/netshoot -w

SRC_POD=$(kubectl get pods -o wide | grep "kind-worker " | awk '{ print($1); }')
DST_IP=$(kubectl get pods -o wide | grep worker3 | awk '{ print($6); }')
kubectl exec -it $SRC_POD -- ping $DST_IP